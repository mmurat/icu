<!doctype html>
<html lang="tr">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="container"></div>
    <script id="template" type="text/ractive">

<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="row">
        <div class="col-md-12">

        <table class="icuEdit">
        <tr>
            <th>Protokol no</th>
            <th>Adı</th>
            <th>İl</th>
            <th>Hastane</th>
            <th>Yoğunbakım</th>
            <th>Güvence</th>
            <th>Yerleşme</th>
            <th>Kullanıcı</th>
        </tr>
        <tr>
            <td><input on-change="editIcuCodeChange" type="number" name="code" style="text-align: right;" value={{ editIcu.code }} {{ cdisabled }}></td>
            <td><input type="input" name="name" value={{ editIcu.name }}></td>
            <td>
            <select value={{ editIcu.province }}>
                {{ #each provinceName:i }}
                    <option value={{i}}> {{ this }}</option>
                {{/each}}
            </select>
            </td>
            <td>
                <select value={{ editIcu.hospital }} {{ hdisabled }}>
                    {{ #each hospitalName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
            <td>
                <select value={{ editIcu.icu_type }} >
                    {{ #each icu_typeName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
            <td>
                <select value={{ editIcu.insurance }}>
                    {{ #each insuranceName:i }}
                        <option value={{ i }}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
            
            <td>
                <select value={{ editIcu.success }} >
                    {{ #each successName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>

            <td>
                <select value={{ editIcu.user }} >
                    {{ #each userName:i }}
                        <option value={{ i }}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
        </tr>
        </table>

    </div>
    </div>
        <div class="row">
            <div class="col-md-6">
            <div class="btn-group btn-group-justified">
                <a on-click="newIcu" class="btn btn-link" style="color: {{ color }};">Yeni</a>
                <a on-click="saveIcu" href="#" class="btn btn-link">Kaydet</a>
                <a href="#" class="btn btn-link">Vazgeç</a>
                <a href="#" class="btn btn-link">Sil</a>
            </div>
            </div>
            <div class="col-md-3">
                <input on-change="date_after_change" type="date" value={{ date_after }}>
            </div>
            <div class="col-md-3">
                <input on-change="date_before_change" type="date" value={{ date_before }}>
            </div>
      
        </div>

    </div>
    </nav>
    
    <div class="container" style="margin-top:10%;">
    <div class="row">
    <div class="col-md-12">
    <table class="icuTable">
        <tr>
            <th>Protokol no</th>
            <th>Adı</th>
            <th>İl</th>
            <th>Hastane</th>
            <th>Yoğunbakım</th>
            <th>Güvence</th>
            <th>Yerleşme</th>
            <th>Tarih</th>
            <th>Kullanıcı</th>
        </tr>
        
    {{ #each icu.data }}
        <tr on-click="activeIcu">
            <td style="text-align:right;">{{ code }}</td>
            <td>{{ name }}</td>
            <td>{{ provinceName[province] }}</td>
            <td>{{ hospitalName[hospital] }}</td>
            <td>{{ icu_typeName[icu_type] }}</td>
            <td>{{ insuranceName[insurance] }}</td>
            <td>{{ successName[success] }}</td>
            <td>{{ date }}</td>
            <td>{{ userName[user] }}</td>
        </tr>
    {{ /each }}

    </table>
    </div>
    </div>
    </div>
    </script>

<script src='js/jquery-1.12.3.js'></script>
<script src='js/ractive.min.js'></script>

<script>


   function getIcu() {
   
    $( document ).ready(function() {

           $.ajax({
            url: "/api/", 
            data_Type: "JSON",
            cache: false,
            success: function(data) {
                console.log(JSON.parse(data));
                ractive.set("icu", JSON.parse(data));

            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
         });
        }); 
    };   


    function getEditIcu(code) {
        $.ajax({
            url: "/api/" + code,
            data_Type: "JSON",
            cache: false,
            success: function(data) {
                  rData = JSON.parse(data);
                  console.log(rData.data.length);
            

                if(rData.data.length != 0) {
                    editIcu =  rData;
                    ractive.set("editIcu", editIcu.data[0]);
                    ractive.set("cdisabled", "disabled");
                    ractive.set("newIcu", false);
                    ractive.set("color", "");
                }
            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
        })
    };    


    function postIcu() {

        var editIcu = ractive.get("editIcu");
        console.log(editIcu);
        var saveIcu =  { 
                                    "code": editIcu.code,
                                    "name": editIcu.name,
                                    "province": editIcu.province,
                                    "hospital": editIcu.hospital,
                                    "icu_type": editIcu.icu_type,
                                    "insurance": editIcu.insurance,
                                    "success": editIcu.success,
                                    "user": editIcu.user
                        };
        console.log(saveIcu);

        $.ajax ({
            type: "POST",
            url: "/api",
            data : saveIcu,
            data_Type: "json",
            cache: false,
            //contentType: "application/json; charset=utf-8",
            success: function(data) {
                console.log(JSON.parse(data));
                getIcu();
            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
        });
    };


    var ractive = new Ractive({
        el: "#container",
        template: "#template",
        data: { 

            icu: getIcu(),
            insuranceName: [ "Bilinmiyor", "SGK", "SSK", "Emekli Sandığı", "Bağkur", "Yeşilkart", "18 yaş altı", "Güvencesiz", "Suriyeli" ],
            userName: [ "Yok" , "Murat Arıca" ],
            icu_typeName: [ "Bilinmiyor/Yok", "Yenidoğan", "Çocuk", "Dahiliye", "Reanimasyon", "Nöroloji", "Beyin Cerrahi", "Koroner", "KVC", "Yanık", "Mikrocerrahi"],
            hospitalName: [ "Bilinmiyor", "ADH", "ÇDH", "Numune", "Balcalı", "Marsa", "Meydan",
                            "SUH", "Y. Başkent", "S. Başkent", "Medline", "Ortadoğu", "Ö. Adana", "G. Adana", "Algomed", "Acıbadem", "Metro" ],
            
            provinceName: ["Bilinmiyor", "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Amasya",
                        "Ankara", "Antalya", "Artvin", "Aydın", "Balıkesir", "Bilecik", "Bingöl",
                        "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum", 
                        "Denizli", "Diyarbakır", "Edirne", "Elazığ", "Erzincan", "Erzurum",
                        "Eskişehir", "Gaziantep", "Giresun", "Gümüşhane", "Hakkâri", "Hatay", 
                        "Isparta", "Mersin", "İstanbul", "İzmir", "Kars", "Kastamonu", "Kayseri",
                        "Kırklareli", "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", 
                        "Manisa", "Kahramanmaraş", "Mardin", "Muğla", "Muş", "Nevşehir", "Niğde",
                        "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", 
                        "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Şanlıurfa", "Uşak",
                        "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman", 
                        "Kırıkkale", "Batman", "Şırnak", "Bartın", "Ardahan", "Iğdır", 
                        "Yalova", "Karabük", "Kilis", "Osmaniye", "Düzce" ],

            successName: [ "Yerleştirilemedi", "İptal", "Servis Hastası", "ADH", 
                            "ÇDH", "Numune", "Balcalı", "Marsa", "Meydan",
                            "SUH", "Y. Başkent", "S. Başkent", "Medline", "Ortadoğu", "Ö. Adana",
                            "G. Adana", "Algomed", "Acıbadem", "Metro"],
        
            newIcu: false,
            editIcu: {},
            date_before: new Date().toJSON().substring(0,10),
            date_after: new Date().toJSON().substring(0,10)
        } 

    });
 
ractive.observe("editIcu.province", function(newValue, oldValue) {
    if( newValue != 1) {
        ractive.set("editIcu.hospital", 0);   
        ractive.set("hdisabled", "disabled");
    }
    else {
       ractive.set("hdisabled", "");
    }
  });

ractive.on( "activeIcu", function ( event ) {
    $(".selected").removeClass("selected");
    $(event.node).addClass('selected');
    
    getEditIcu(event.context.code);
    ractive.set("cdisabled", "disabled");
    ractive.set("newIcu", false);
    ractive.set("color", "");
});

ractive.on("newIcu", function(event) {
    ractive.set("editIcu", {province: 0, hospital: 0, icu_type: 0, insurance: 0, success: 0, user: 0});
    $(".selected").removeClass("selected");
    ractive.set("newIcu", true);
    ractive.set("color", "red");
    ractive.set("cdisabled", "");
});

/*ractive.observe("newIcu", function(newValue, oldValue) {
    console.log(newValue);
});
*/
ractive.on("editIcuCodeChange", function(event) {

    getEditIcu(event.context.editIcu.code);
/*  ractive.set("cdisabled", "disabled");
    ractive.set("newIcu", false);
    ractive.set("color", "");
*/});

ractive.on("date_after_change", function(event) {
    var date_after = ractive.get("date_after").split("-"); 
    var date_before = ractive.get("date_before").split("-"); 
    url = "/api/" + date_after[0] + "/" + date_after[1] + "/" + date_after[2] + "/" + date_before[0] + "/" + date_before[1] + "/" + date_before[2];
    console.log(url);

        $.ajax({
            url: url, 
            data_Type: "JSON",
            cache: false,
            success: function(data) {
                console.log(JSON.parse(data));
                ractive.set("icu", JSON.parse(data));

            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
         });
});

ractive.on("date_before_change", function(event) {
    var date_after = ractive.get("date_after").split("-"); 
    var date_before = ractive.get("date_before").split("-"); 
    url = "/api/" + date_after[0] + "/" + date_after[1] + "/" + date_after[2] + "/" + date_before[0] + "/" + date_before[1] + "/" + date_before[2];
    console.log(url);

        $.ajax({
            url: url, 
            data_Type: "JSON",
            cache: false,
            success: function(data) {
                console.log(JSON.parse(data));
                ractive.set("icu", JSON.parse(data));

            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
         });
});

ractive.on("saveIcu", function(event) {
    if(ractive.get("newIcu")) {
        postIcu();
    }
});

</script>
</body>
</html>