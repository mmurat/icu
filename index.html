<!doctype html>
<html lang="tr">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf8" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="container"></div>
    <script id="template" type="text/ractive">

<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="row">
        <div class="col-md-12">

        <table class="icuEdit">
        <tr>
            <th>Protokol no</th>
            <th>Adı</th>
            <th>İl</th>
            <th>Hastane</th>
            <th>Yoğunbakım</th>
            <th>Güvence</th>
            <th>Yerleşme</th>
            <th>Kullanıcı</th>
        </tr>
        <tr>
            <td><input type="input" name="code" value={{newIcu.code}}></td>
            <td><input type="input" name="name" value={{newIcu.name}}></td>
            <td>
            <select value="{{newIcu.province}}">
                {{ #each provinceName:i }}
                    <option value={{i}}> {{ this }}</option>
                {{/each}}
            </select>
            </td>
            <td>
                <select value={{newIcu.province}} {{disabled}} >
                    {{ #each hospitalName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
            <td>
                <select value={{ newIcu.icu_type }} >
                    {{ #each icu_typeName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
            <td>
                <select value={{newIcu.insurance}}>
                    {{ #each insuranceName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
            
            <td>
                <select value={{newIcu.success}} >
                    {{ #each successName }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>

            <td>
                <select value={{newIcu.user}} >
                    {{ #each userName:i }}
                        <option value={{i}}>{{ this }}</option>
                    {{/each}}
                </select>
            </td>
        </tr>
        </table>

    </div>
    </div>
        <div class="row">
            <div class="col-md-6">
            <div class="btn-group btn-group-justified">
                <a on-click="newIcu" class="btn btn-link">Yeni</a>
                <a href="#" class="btn btn-link">Kaydet</a>
                <a href="#" class="btn btn-link">Vazgeç</a>
                <a href="#" class="btn btn-link">Sil</a>
            </div>
            </div>
            <div class="col-md-6">
                <p></p>
            </div>
        </div>
    </div>
    </nav>
    
    <div class="container" style="margin-top:10%;">
    <div class="row">
    <div class="col-md-12">
    <table class="icuTable">
        <tr>
            <th>Protokol no</th>
            <th>Adı</th>
            <th>İl</th>
            <th>Hastane</th>
            <th>Yoğunbakım</th>
            <th>Güvence</th>
            <th>Yerleşme</th>
            <th>Tarih</th>
            <th>Kullanıcı</th>
        </tr>
        
    {{ #each icu.data }}
        <tr on-click="activeIcu">
            <td style="text-align:right;">{{ code }}</td>
            <td>{{ name }}</td>
            <td>{{ provinceName[province] }}</td>
            <td>{{ hospitalName[hospital] }}</td>
            <td>{{ icu_typeName[icu_type] }}</td>
            <td>{{ insuranceName[insurance] }}</td>
            <td>{{ successName[success] }}</td>
            <td>{{ date }}</td>
            <td>{{ userName[user] }}</td>
        </tr>
    {{ /each }}

    </table>
    </div>
    </div>
    </div>
    </script>

<script src='js/jquery-1.12.3.js'></script>
<script src='js/ractive.min.js'></script>

<script>
    
    function getIcu() {
        $.ajax({
            url: "/api",
            data_Type: "json",
            cache: false,
            success: function(data) {
                console.log(JSON.parse(data));
                ractive.set("icu", JSON.parse(data));

            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
        })
    };    


    function getEditIcu(code) {
        $.ajax({
            url: "/api/" + code,
            data_Type: "json",
            cache: false,
            success: function(data) {
                console.log(JSON.parse(data));
                ractive.set("newIcu", JSON.parse(data));
            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
        })
    };    


    function postIcu(newIcu) {
        $.ajax ({
            type: "POST",
            url: "/api",
            data : newIcu,
            data_Type: "json",
            cache: false,
            success: function(data) {
                console.log(JSON.parse(data));
                getIcu();
            }.bind(this),
            
            error: function(xhr, status, err) {
                console.log(err) ;
            }.bind(this)
        });
    };


    var ractive = new Ractive({
       el: "#container",
        template: "#template",
        data: { 

            icu: getIcu(),
            insuranceName: [ "Bilinmiyor", "SGK", "SSK", "Emekli Sandığı", "Bağkur", "Yeşilkart", "18 yaş altı", "Güvencesiz", "Suriyeli" ],
            userName: [ "Yok" , "Murat Arıca" ],
            icu_typeName: [ "Bilinmiyor/Yok", "Yenidoğan", "Çocuk", "Dahiliye", "Reanimasyon", "Nöroloji", "Beyin Cerrahi", "Koroner", "KVC", "Yanık", "Mikrocerrahi"],
            hospitalName: [ "Bilinmiyor", "ADH", "ÇDH", "Numune", "Balcalı", "Marsa", "Meydan",
                            "SUH", "Y. Başkent", "S. Başkent", "Medline", "Ortadoğu", "Ö. Adana", "G. Adana", "Algomed", "Acıbadem", "Metro" ],
            
            provinceName: ["Bilinmiyor", "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Amasya",
                        "Ankara", "Antalya", "Artvin", "Aydın", "Balıkesir", "Bilecik", "Bingöl",
                        "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum", 
                        "Denizli", "Diyarbakır", "Edirne", "Elazığ", "Erzincan", "Erzurum",
                        "Eskişehir", "Gaziantep", "Giresun", "Gümüşhane", "Hakkâri", "Hatay", 
                        "Isparta", "Mersin", "İstanbul", "İzmir", "Kars", "Kastamonu", "Kayseri",
                        "Kırklareli", "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", 
                        "Manisa", "Kahramanmaraş", "Mardin", "Muğla", "Muş", "Nevşehir", "Niğde",
                        "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", 
                        "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Şanlıurfa", "Uşak",
                        "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman", 
                        "Kırıkkale", "Batman", "Şırnak", "Bartın", "Ardahan", "Iğdır", 
                        "Yalova", "Karabük", "Kilis", "Osmaniye", "Düzce" ],

            successName: [ "Yerleştirilemedi", "İptal", "Servis Hastası", "ADH", 
                            "ÇDH", "Numune", "Balcalı", "Marsa", "Meydan",
                            "SUH", "Y. Başkent", "S. Başkent", "Medline", "Ortadoğu", "Ö. Adana",
                            "G. Adana", "Algomed", "Acıbadem", "Metro"],
        
            disabled: "disabled",

            selectedIcu: {},
            newIcu: {},
            editIcu: {}
        } 

        /*{
            icu: $.get("http://127.0.0.1:8000", function( icu ) {
                console.log(icu);
                return icu;
                          })
        }*/

        });
 
ractive.observe("newIcuProvince", function(newValue, oldValue) {
    if( newValue != 1) {
        ractive.set("newIcuHospital", 0);
        ractive.set("disabled", "disabled");
    }
    else {
        ractive.set("disabled", "");
    }
  });

ractive.on( "activeIcu", function ( event ) {
    $(".selected").removeClass("selected");
    $(event.node).addClass('selected');
    
    getEditIcu(event.context.code);
 
    ractive.set("selectedIcu", event.context);
    ractive.set("newIcu", event.context);
    console.log(event.context);
});

ractive.on("newIcu", function(event) {
    ractive.set("selectedIcu", {province: 0, hospital: 0, icu_type: 0, insurance: 0, success: 0, user: 0});
    $(".selected").removeClass("selected");
});

</script>
</body>
</html>